# Production Docker Compose - Temporal orchestration
#
# Port allocation: found-footy uses 3100-3119 (production)
#   3100: Temporal UI
#   3101: MongoDB Compass (web GUI)
#   3102: MinIO Console
#   3103: Twitter-1 VNC (only instance with GUI for debugging/re-auth)
#
# Internal ports (not exposed):
#   - postgres:5432 (Temporal metadata)
#   - mongo:27017 (Application data)
#   - minio:9000 (S3 storage)
#   - temporal:7233 (gRPC)
#   - twitter-N:8888 (API)
#
# External services (on luv-prod network):
#   - llama-chat:8080 (LLM API - llama.cpp chat+vision)
#
# SCALING:
#   - Twitter browsers: min 2, max 8 (twitter-1 through twitter-8)
#     - twitter-1: VNC enabled (port 3103) for debugging/re-auth
#     - twitter-2+: Headless (no VNC) for scalability
#   - Workers: min 2, max 8 (worker-1 through worker-8)
#   - Scaler service monitors load and starts/stops instances
#   - Start minimum: docker compose up -d
#   - Scale up: docker compose up -d twitter-3
#   - Scale down: docker compose stop twitter-3
#
# BUILD SHORTCUTS:
#   - docker compose build worker - Builds worker image (used by all worker-N)
#   - docker compose build twitter - Builds twitter image (used by all twitter-N)
#   - docker compose up -d worker-1 worker-2 - Restarts running workers with new image

name: found-footy-prod

# =============================================================================
# EXTENSION FIELDS (YAML anchors for DRY config)
# =============================================================================

# Base twitter config (shared by all instances)
x-twitter-base: &twitter-base
  build:
    context: .
    dockerfile: Dockerfile
  image: found-footy-prod-twitter:latest
  env_file:
    - .env
  volumes:
    - found-footy-prod-twitter-cookies:/data
    - ~/.config/found-footy:/config
  networks:
    - found-footy-prod
  restart: unless-stopped

# Twitter with VNC (for twitter-1 only - debugging/re-auth)
x-twitter-vnc: &twitter-vnc
  <<: *twitter-base
  environment: &twitter-vnc-env
    PYTHONPATH: /app
    TWITTER_COOKIES_FILE: /data/twitter_cookies.pkl
    TWITTER_COOKIE_BACKUP_PATH: /config/twitter_cookies.json
    TWITTER_SERVICE_HOST: "0.0.0.0"
    TWITTER_SERVICE_PORT: "8888"
    TWITTER_HEADLESS: "false"
    DISPLAY: ":99"
  command: bash /app/twitter/start_with_vnc.sh

# Twitter headless (for twitter-2+ - scalable, no GUI)
x-twitter-headless: &twitter-headless
  <<: *twitter-base
  environment: &twitter-headless-env
    PYTHONPATH: /app
    TWITTER_COOKIES_FILE: /data/twitter_cookies.pkl
    TWITTER_COOKIE_BACKUP_PATH: /config/twitter_cookies.json
    TWITTER_SERVICE_HOST: "0.0.0.0"
    TWITTER_SERVICE_PORT: "8888"
    TWITTER_HEADLESS: "true"
  command: bash /app/twitter/start_headless.sh

x-worker-common: &worker-common
  build:
    context: .
    dockerfile: Dockerfile
  image: found-footy-prod-worker:latest
  env_file:
    - .env
  environment: &worker-env
    PYTHONPATH: /app
    TEMPORAL_HOST: found-footy-prod-temporal:7233
    MONGODB_URI: mongodb://ffuser:ffpass@found-footy-prod-mongo:27017/found_footy?authSource=admin
    S3_ENDPOINT_URL: http://found-footy-prod-minio:9000
    S3_ACCESS_KEY: ffuser
    S3_SECRET_KEY: ffpass--
    S3_BUCKET_NAME: footy-videos
    FRONTEND_API_URL: http://vedanta-systems-prod-api:3001
    LLAMA_URL: http://llama-chat:8080
    FOOTY_TEMP_DIR: /tmp/found-footy
  volumes:
    - ~/.config/found-footy:/config
    - found-footy-prod-temp:/tmp/found-footy
  networks:
    - found-footy-prod
    - luv-prod
  depends_on:
    - temporal
    - mongo
  restart: unless-stopped
  deploy:
    resources:
      limits:
        cpus: '2'
        memory: 4G
  command: python /app/src/worker.py

# =============================================================================
# SERVICES
# =============================================================================

services:
  # ===========================================================================
  # BUILD-ONLY SERVICES (for docker compose build worker/twitter)
  # ===========================================================================
  
  # Build-only: docker compose build twitter builds image used by all twitter-N
  twitter:
    <<: *twitter-base
    profiles: ["build-only"]

  # Build-only: docker compose build worker builds image used by all worker-N
  worker:
    <<: *worker-common
    profiles: ["build-only"]

  # ===========================================================================
  # TWITTER SERVICES (1-8) - Firefox browser instances for Twitter scraping
  # twitter-1: VNC enabled (port 3103) for debugging/re-auth
  # twitter-2+: Headless (no VNC, no ports) for scalability
  # ===========================================================================
  twitter-1:
    <<: *twitter-vnc
    container_name: found-footy-prod-twitter-1
    ports:
      - "3103:6080"
    environment:
      <<: *twitter-vnc-env
      TWITTER_INSTANCE_ID: "1"

  twitter-2:
    <<: *twitter-headless
    container_name: found-footy-prod-twitter-2
    environment:
      <<: *twitter-headless-env
      TWITTER_INSTANCE_ID: "2"

  twitter-3:
    <<: *twitter-headless
    container_name: found-footy-prod-twitter-3
    environment:
      <<: *twitter-headless-env
      TWITTER_INSTANCE_ID: "3"
    profiles: ["scale"]

  twitter-4:
    <<: *twitter-headless
    container_name: found-footy-prod-twitter-4
    environment:
      <<: *twitter-headless-env
      TWITTER_INSTANCE_ID: "4"
    profiles: ["scale"]

  twitter-5:
    <<: *twitter-headless
    container_name: found-footy-prod-twitter-5
    environment:
      <<: *twitter-headless-env
      TWITTER_INSTANCE_ID: "5"
    profiles: ["scale"]

  twitter-6:
    <<: *twitter-headless
    container_name: found-footy-prod-twitter-6
    environment:
      <<: *twitter-headless-env
      TWITTER_INSTANCE_ID: "6"
    profiles: ["scale"]

  twitter-7:
    <<: *twitter-headless
    container_name: found-footy-prod-twitter-7
    environment:
      <<: *twitter-headless-env
      TWITTER_INSTANCE_ID: "7"
    profiles: ["scale"]

  twitter-8:
    <<: *twitter-headless
    container_name: found-footy-prod-twitter-8
    environment:
      <<: *twitter-headless-env
      TWITTER_INSTANCE_ID: "8"
    profiles: ["scale"]

  # ===========================================================================
  # WORKER SERVICES (1-8) - Temporal workflow workers
  # ===========================================================================
  worker-1:
    <<: *worker-common
    container_name: found-footy-prod-worker-1
    environment:
      <<: *worker-env
      WORKER_INSTANCE_ID: "1"

  worker-2:
    <<: *worker-common
    container_name: found-footy-prod-worker-2
    environment:
      <<: *worker-env
      WORKER_INSTANCE_ID: "2"

  worker-3:
    <<: *worker-common
    container_name: found-footy-prod-worker-3
    environment:
      <<: *worker-env
      WORKER_INSTANCE_ID: "3"
    profiles: ["scale"]

  worker-4:
    <<: *worker-common
    container_name: found-footy-prod-worker-4
    environment:
      <<: *worker-env
      WORKER_INSTANCE_ID: "4"
    profiles: ["scale"]

  worker-5:
    <<: *worker-common
    container_name: found-footy-prod-worker-5
    environment:
      <<: *worker-env
      WORKER_INSTANCE_ID: "5"
    profiles: ["scale"]

  worker-6:
    <<: *worker-common
    container_name: found-footy-prod-worker-6
    environment:
      <<: *worker-env
      WORKER_INSTANCE_ID: "6"
    profiles: ["scale"]

  worker-7:
    <<: *worker-common
    container_name: found-footy-prod-worker-7
    environment:
      <<: *worker-env
      WORKER_INSTANCE_ID: "7"
    profiles: ["scale"]

  worker-8:
    <<: *worker-common
    container_name: found-footy-prod-worker-8
    environment:
      <<: *worker-env
      WORKER_INSTANCE_ID: "8"
    profiles: ["scale"]

  # ===========================================================================
  # INFRASTRUCTURE SERVICES
  # ===========================================================================

  # POSTGRESQL - Temporal metadata storage
  postgres:
    image: postgres:15-alpine
    container_name: found-footy-prod-postgres
    environment:
      POSTGRES_USER: ffuser
      POSTGRES_PASSWORD: ffpass
      POSTGRES_DB: temporal
    volumes:
      - found-footy-prod-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ffuser -d temporal"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - found-footy-prod
      - luv-prod

  # MONGODB - application data storage (standalone, no replica set needed)
  mongo:
    image: mongo:7-jammy
    container_name: found-footy-prod-mongo
    command: mongod --wiredTigerCacheSizeGB 0.25
    environment:
      MONGO_INITDB_ROOT_USERNAME: ffuser
      MONGO_INITDB_ROOT_PASSWORD: ffpass
      MONGO_INITDB_DATABASE: found_footy
    volumes:
      - found-footy-prod-mongo-data:/data/db
      - found-footy-prod-mongo-config:/data/configdb
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - found-footy-prod
      - luv-prod

  # MONGO EXPRESS - Lightweight MongoDB web GUI
  mongo-express:
    image: mongo-express:latest
    container_name: found-footy-prod-mongo-express
    ports:
      - "3101:8081"
    environment:
      ME_CONFIG_MONGODB_SERVER: found-footy-prod-mongo
      ME_CONFIG_MONGODB_PORT: "27017"
      ME_CONFIG_MONGODB_ADMINUSERNAME: ffuser
      ME_CONFIG_MONGODB_ADMINPASSWORD: ffpass
      ME_CONFIG_BASICAUTH: "false"
      ME_CONFIG_OPTIONS_EDITORTHEME: "ambiance"
      ME_CONFIG_REQUEST_SIZE: "100kb"
      ME_CONFIG_MONGODB_ENABLE_ADMIN: "true"
    depends_on:
      mongo:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - found-footy-prod

  # MINIO - S3-compatible object storage
  minio:
    image: minio/minio:latest
    container_name: found-footy-prod-minio
    command: server /data --console-address ":9001"
    ports:
      - "3102:9001"
    environment:
      MINIO_ROOT_USER: ffuser
      MINIO_ROOT_PASSWORD: ffpass--
    volumes:
      - found-footy-prod-minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - found-footy-prod
      - luv-prod

  # TEMPORAL SERVER - Workflow orchestration
  temporal:
    image: temporalio/auto-setup:latest
    container_name: found-footy-prod-temporal
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=ffuser
      - POSTGRES_PWD=ffpass
      - POSTGRES_SEEDS=found-footy-prod-postgres
      - BIND_ON_IP=0.0.0.0
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - found-footy-prod
    restart: unless-stopped

  # TEMPORAL UI - Web interface
  temporal-ui:
    image: temporalio/ui:latest
    container_name: found-footy-prod-temporal-ui
    ports:
      - "3100:8080"
    environment:
      - TEMPORAL_ADDRESS=found-footy-prod-temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3100
    depends_on:
      - temporal
    networks:
      - found-footy-prod
    restart: unless-stopped

  # ===========================================================================
  # SCALER SERVICE (optional) - Auto-scales workers/twitter based on load
  # ===========================================================================
  scaler:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: found-footy-prod-scaler
    environment:
      PYTHONPATH: /app
      MONGODB_URI: mongodb://ffuser:ffpass@found-footy-prod-mongo:27017/found_footy?authSource=admin
      TEMPORAL_HOST: found-footy-prod-temporal:7233
      COMPOSE_DIR: /home/vedanta/workspace/dev/found-footy
      MIN_TWITTER_INSTANCES: "2"
      MAX_TWITTER_INSTANCES: "8"
      MIN_WORKER_INSTANCES: "2"
      MAX_WORKER_INSTANCES: "8"
      SCALE_CHECK_INTERVAL: "30"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/vedanta/workspace/dev/found-footy:/workspace:ro
    networks:
      - found-footy-prod
    depends_on:
      - temporal
      - mongo
    restart: unless-stopped
    command: python /app/src/scaler/scaler_service.py
    profiles: ["scaler"]

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  found-footy-prod-postgres-data:
    name: found-footy-prod-postgres-data
    driver: local
  found-footy-prod-mongo-data:
    name: found-footy-prod-mongo-data
    driver: local
  found-footy-prod-mongo-config:
    name: found-footy-prod-mongo-config
    driver: local
  found-footy-prod-minio-data:
    name: found-footy-prod-minio-data
    driver: local
  found-footy-prod-twitter-cookies:
    name: found-footy-prod-twitter-cookies
    driver: local
  found-footy-prod-temp:
    name: found-footy-prod-temp
    driver: local

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  found-footy-prod:
    name: found-footy-prod
    driver: bridge
  
  luv-prod:
    external: true
