# âš½ Found Footy - Automated Football Goal Highlights Pipeline

**4-collection in-place debounce architecture** - detects football goals in real-time, validates stability with hash-based debounce, discovers videos on Twitter, and stores in S3. Built with Dagster orchestration and MongoDB storage.

---

## ğŸ¯ Architecture Overview

**4-Collection Design with In-Place Enhancement**

Raw API data stored in `fixtures_live` for comparison, enhanced data in `fixtures_active` - **never overwritten!**

```
fixtures_staging     â†’ Waiting to start (TBD, NS)
     â†“ (start time reached, activated with empty events array)
fixtures_active      â†’ Enhanced events with debounce fields (NEVER replaced)
     â†“ (monitor stores fresh API data here â†“)
fixtures_live        â†’ Temporary raw API data for comparison (overwritten each poll)
     â†“ (status FT/AET/PEN, after final debounce)
fixtures_completed   â†’ Archive with all enhancements intact
```

```mermaid
flowchart TB
    API[API-Football Poll] --> Live[fixtures_live<br/>Raw API data<br/>Filtered events only<br/>_event_id generated]
    Live --> Compare{Compare<br/>live vs active}
    
    Compare -->|Case 1: NEW| Debounce[Debounce Job]
    Compare -->|Case 2: INCOMPLETE| Debounce
    Compare -->|Case 3: REMOVED| Debounce
    
    Debounce -->|Add new event<br/>stable_count=1| Active[fixtures_active<br/>Enhanced events<br/>Never overwritten]
    Debounce -->|Update stable_count<br/>Add snapshot| Active
    Debounce -->|Mark removed| Active
    
    Active -->|stable_count=3<br/>_debounce_complete=true| Twitter[Twitter Job]
    Active -->|Status FT/AET/PEN<br/>After debounce| Completed[fixtures_completed<br/>Archive]
    
    Twitter -->|Videos found| S3[MinIO S3 Storage]
```

### Event Enhancement Pattern

**fixtures_live:** Raw API data with `_event_id` generated (filtered to Goals only):
```javascript
{
  "player": {"id": 234, "name": "D. Szoboszlai"},
  "team": {"id": 40, "name": "Liverpool"},
  "type": "Goal",
  "detail": "Normal Goal",
  "time": {"elapsed": 23},
  "_event_id": "5000_234_23_Goal_Normal Goal"  // Generated by monitor
}
```

**fixtures_active:** Enhanced events with debounce tracking (added in-place):
```javascript
{
  // Raw API fields (from live)
  "player": {"id": 234, "name": "D. Szoboszlai"},
  "team": {"id": 40, "name": "Liverpool"},
  "type": "Goal",
  "detail": "Normal Goal",
  "time": {"elapsed": 23},
  
  // Enhanced fields (added by debounce_job)
  "_event_id": "5000_234_23_Goal_Normal Goal",
  "_stable_count": 3,
  "_debounce_complete": true,
  "_twitter_complete": false,
  "_first_seen": "2025-11-24T15:23:45Z",
  "_snapshots": [
    {"timestamp": "2025-11-24T15:23:45Z", "hash": "abc123"},
    {"timestamp": "2025-11-24T15:24:45Z", "hash": "abc123"},
    {"timestamp": "2025-11-24T15:25:45Z", "hash": "abc123"}
  ],
  "_score_before": {"home": 0, "away": 0},
  "_score_after": {"home": 1, "away": 0},
  "_scoring_team": "home",
  "_twitter_search": "Szoboszlai Liverpool"
}
```

---

## ğŸ”„ Pipeline Flow

```mermaid
sequenceDiagram
    participant Monitor
    participant Live as fixtures_live
    participant Active as fixtures_active
    participant Debounce
    participant Twitter
    
    Monitor->>Live: Store filtered API data<br/>with _event_id
    Monitor->>Monitor: Compare live vs active
    
    alt Case 1: NEW events
        Monitor->>Debounce: Trigger debounce
        Debounce->>Active: Add new event<br/>stable_count=1
    end
    
    alt Case 2: INCOMPLETE events
        Monitor->>Debounce: Trigger debounce
        Debounce->>Debounce: Compare hash
        alt Hash same
            Debounce->>Active: Increment stable_count
            alt stable_count >= 3
                Debounce->>Active: Mark debounce_complete
                Debounce->>Twitter: Trigger twitter job
            end
        else Hash changed
            Debounce->>Active: Reset stable_count=1
        end
    end
    
    alt Case 3: REMOVED events
        Monitor->>Debounce: Trigger debounce
        Debounce->>Active: Mark event removed
    end
```

### 1. Ingest Job (Daily 00:05 UTC)

Fetches today's fixtures and routes to appropriate collections:

```
1. Fetch fixtures from API-Football
2. Filter to 50 tracked teams
3. Route by status:
   - TBD/NS â†’ fixtures_staging
   - LIVE â†’ fixtures_active (with empty events array)
   - FT/AET/PEN â†’ fixtures_completed
```

### 2. Monitor Job (Every Minute)

Activates fixtures and triggers debounce when needed:

```
1. Activate fixtures (staging â†’ active with EMPTY events array)
2. Batch fetch fresh API data for ALL active fixtures
3. Filter events (Goals only) and store in fixtures_live WITH _event_id
4. Compare fixtures_live vs fixtures_active (3 trigger cases)
5. If needs_debounce: directly invoke debounce_job(fixture_id)
6. After debounce: Move FT/AET/PEN fixtures to completed
```

**3 Cases That Trigger Debounce:**
- **NEW:** Event in live but NOT in active
- **INCOMPLETE:** Event in both but `_debounce_complete=false`
- **REMOVED:** Event in active but NOT in live (VAR disallowed)

### 3. Debounce Job (Per Fixture)

Processes events using clean iteration pattern:

```
1. Get live events (with _event_id) and active events
2. Build dict of live events by _event_id
3. Iterate active events:
   
   IF event_id in live_events_dict:
     Pop event from dict
     
     IF hash unchanged:
       â†’ Increment stable_count
       â†’ Add snapshot
       â†’ If stable_count >= 3: mark debounce_complete, trigger twitter
     ELSE:
       â†’ Reset stable_count = 1 (hash changed)
   
   ELSE (not in live):
     â†’ Mark event as removed (VAR case)

4. Whatever's left in live_events_dict = NEW events
   â†’ Add to active with stable_count=1
```

**Hash Fields:** `player_id`, `team_id`, `type`, `detail`, `time_elapsed`, `assist_id`

### 4. Twitter Job (Per Event)

Called when `_debounce_complete=true`:

```
1. Get event from fixtures_active.events array
2. Use prebuilt _twitter_search field
3. Search Twitter for videos
4. Download videos to MinIO
5. Mark _twitter_complete=true
```

---

## ğŸ“Š MongoDB Collections (4 Total)

### fixtures_staging

Fixtures waiting to start (status TBD, NS).

```json
{
  "_id": 5000,
  "fixture": {
    "id": 5000,
    "date": "2025-11-24T15:00:00Z",
    "status": {"short": "TBD"}
  },
  "teams": {
    "home": {"id": 40, "name": "Liverpool"},
    "away": {"id": 50, "name": "Man City"}
  }
}
```

### fixtures_live

**Temporary storage** for raw API data with filtered events (Goals only). Gets **overwritten** each poll.

```json
{
  "_id": 5000,
  "stored_at": "2025-11-24T15:25:00Z",
  "fixture": {...},
  "teams": {...},
  "events": [
    {
      "player": {"id": 234, "name": "D. Szoboszlai"},
      "team": {"id": 40, "name": "Liverpool"},
      "type": "Goal",
      "detail": "Normal Goal",
      "time": {"elapsed": 23},
      "_event_id": "5000_234_23_Goal_Normal Goal"  // Generated by monitor
    }
  ]
}
```

### fixtures_active

Enhanced fixtures with debounce tracking. Events array **grows incrementally**, **never replaced**.

```json
{
  "_id": 5000,
  "activated_at": "2025-11-24T15:00:00Z",
  "fixture": {...},
  "teams": {...},
  "events": [
    {
      // Raw API fields
      "player": {"id": 234, "name": "D. Szoboszlai"},
      "team": {"id": 40, "name": "Liverpool"},
      "type": "Goal",
      "detail": "Normal Goal",
      "time": {"elapsed": 23},
      
      // Enhanced fields (added by debounce_job, never overwritten)
      "_event_id": "5000_234_23_Goal_Normal Goal",
      "_stable_count": 3,
      "_debounce_complete": true,
      "_twitter_complete": false,
      "_first_seen": "2025-11-24T15:23:45Z",
      "_snapshots": [
        {"timestamp": "2025-11-24T15:23:45Z", "hash": "abc123"},
        {"timestamp": "2025-11-24T15:24:45Z", "hash": "abc123"},
        {"timestamp": "2025-11-24T15:25:45Z", "hash": "abc123"}
      ],
      "_score_before": {"home": 0, "away": 0},
      "_score_after": {"home": 1, "away": 0},
      "_scoring_team": "home",
      "_twitter_search": "Szoboszlai Liverpool"
    }
  ]
}
```

### fixtures_completed

Archive of finished fixtures with all enhancements intact. fixtures_live entry is deleted when moved here.

---

## ğŸ”Œ Port Configuration

**Development Access (via SSH forwarding):**
- **Dagster UI:** http://localhost:3100
- **MongoDB Express:** http://localhost:3101  
- **MinIO Console:** http://localhost:3102
- **Twitter VNC:** http://localhost:6080/vnc.html

**Internal Services:**
- PostgreSQL: `postgres:5432`
- MongoDB: `mongo:27017`
- MinIO API: `minio:9000`

---

## ğŸš€ Getting Started

### Prerequisites

- Docker & Docker Compose
- Python 3.11+
- SSH access to server (for port forwarding)

### Quick Start

```bash
# 1. Clone repo
git clone <repo-url>
cd found-footy

# 2. Set up environment
cp .env.example .env
# Edit .env with your API-Football key

# 3. Start services
docker-compose up -d

# 4. SSH port forwarding (from local machine)
ssh -L 3100:localhost:3100 -L 3101:localhost:3101 -L 3102:localhost:3102 user@server

# 5. Access Dagster UI
# Open http://localhost:3100 in your browser
```

---

## ğŸ“‚ Project Structure

```
found-footy/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ mongo_store.py       # 4 collections (staging/live/active/completed)
â”‚   â”‚   â””â”€â”€ s3_store.py          # MinIO video storage
â”‚   â”œâ”€â”€ jobs/
â”‚   â”‚   â”œâ”€â”€ ingest/              # Daily fixture ingestion
â”‚   â”‚   â”œâ”€â”€ monitor/             # Per-minute monitoring + comparison
â”‚   â”‚   â”œâ”€â”€ debounce/            # Per-fixture event validation (clean iteration)
â”‚   â”‚   â”œâ”€â”€ twitter/             # Per-event video discovery
â”‚   â”‚   â””â”€â”€ download/            # Video download & dedup
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ event_config.py      # Event filtering config (Goals only)
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ mongo_api.py         # API-Football wrapper
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Dockerfile
â””â”€â”€ README.md
```

---

## ğŸ¯ Key Features

- **4-Collection Architecture** - Staging â†’ Live (temp) â†’ Active (enhanced) â†’ Completed
- **In-Place Enhancement** - Events enhanced incrementally, never overwritten
- **Clean Iteration Pattern** - Build dict, pop as processed, leftovers are NEW
- **Event Filtering** - Only Goals stored (Normal Goal, Penalty, Own Goal)
- **Hash-Based Stability** - MD5 of critical fields, 3 consecutive stable polls
- **3 Debounce Trigger Cases** - NEW, INCOMPLETE, REMOVED (VAR)
- **Pre-Generated Event IDs** - Set in monitor for clean comparison
- **Smart Twitter Search** - Player last name + team name
- **MinIO Storage** - S3-compatible local video storage
- **Dagster Orchestration** - Visual pipeline monitoring

---

## ğŸ› Debugging

### Check Active Fixtures

```bash
# MongoDB Express
http://localhost:3101

# Click: found_footy â†’ fixtures_active
# Look at events array for enhanced fields
```

### Check Dagster Logs

```bash
# Dagster UI
http://localhost:3100

# Click: Runs â†’ Select job â†’ View logs
```

### Manual Job Triggers

```python
# In Dagster UI, go to Jobs and click "Launch Run"
# Provide config for twitter_job:
{
  "ops": {
    "search_and_save_twitter_videos": {
      "config": {
        "fixture_id": 5000,
        "event_id": "5000_234_Goal_1"
      }
    }
  }
}
```

---

## ğŸ“ Notes

- **API Limit:** 7500 requests/day (Pro plan)
- **Batch Endpoint:** Gets fixtures + events + lineups in one call
- **Debounce Window:** 3 polls at 1-minute intervals
- **Twitter Retry:** 2min initial + 3min + 4min (total ~10min)
- **Storage:** MinIO (S3-compatible) at `minio:9000`

---

## ğŸ”® Future Enhancements

- [ ] Actual Twitter integration (currently placeholder)
- [ ] Video download & deduplication with OpenCV
- [ ] Frontend UI to query fixtures_active
- [ ] Webhook notifications for completed events
- [ ] Multi-league support beyond 50 teams

---

## ğŸ“œ License

MIT
