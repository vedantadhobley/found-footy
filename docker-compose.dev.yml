# Development Docker Compose - Temporal orchestration
#
# Port allocation: found-footy uses 4100-4109 (dev)
#   4100: Temporal UI
#   4101: MongoDB Compass (web GUI)
#   4102: MinIO Console
#   4103: Twitter Firefox VNC (browser GUI)
#   7233: Temporal gRPC
#
# Internal ports:
#   - found-footy-postgres:5432 (Temporal metadata)
#   - found-footy-mongo:27017 (Application data)
#   - found-footy-minio:9000 (S3 storage)

services:
  # TWITTER SERVICE - handles Twitter scraping with GUI access
  twitter:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: found-footy-dev-twitter
    ports:
      - "4103:6080"  # noVNC Browser - view Firefox at http://localhost:4103
    env_file:
      - .env
    environment:
      PYTHONPATH: /workspace
      TWITTER_COOKIES_FILE: /data/twitter_cookies.pkl
      TWITTER_COOKIE_BACKUP_PATH: /config/twitter_cookies.json
      TWITTER_SERVICE_HOST: "0.0.0.0"
      TWITTER_SERVICE_PORT: "8888"
      TWITTER_HEADLESS: "false"  # GUI mode - full browser visible via noVNC!
      DISPLAY: ":99"
      VNC_PORT: "5900"
      NOVNC_PORT: "6080"
    volumes:
      - .:/workspace  # Mount entire project for development
      - found-footy-dev-twitter-cookies:/data
      - ~/.config/found-footy:/config  # Cookie backup (outside repo)
    networks:
      - found-footy-dev
    restart: unless-stopped
    command: bash /workspace/twitter/start_with_vnc.sh

  # POSTGRESQL - Temporal metadata storage
  postgres:
    image: postgres:15-alpine
    container_name: found-footy-dev-postgres
    environment:
      POSTGRES_USER: ffuser
      POSTGRES_PASSWORD: ffpass
      POSTGRES_DB: temporal
    volumes:
      - found-footy-dev-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ffuser -d temporal"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - found-footy-dev
      - luv-dev

  # MONGODB - application data storage (standalone, no replica set needed)
  mongo:
    image: mongo:7-jammy
    container_name: found-footy-dev-mongo
    # No port mapping - accessed via Mongoku dashboard
    environment:
      MONGO_INITDB_ROOT_USERNAME: ffuser
      MONGO_INITDB_ROOT_PASSWORD: ffpass
      MONGO_INITDB_DATABASE: found_footy
    volumes:
      - found-footy-dev-mongo-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - found-footy-dev
      - luv-dev
  
  # MONGOKU - MongoDB web GUI (supports integer IDs)
  mongoku:
    image: huggingface/mongoku:latest
    container_name: found-footy-dev-mongoku
    ports:
      - "4101:3100"  # Mongoku Web UI
    environment:
      MONGOKU_DEFAULT_HOST: mongodb://ffuser:ffpass@found-footy-dev-mongo:27017
      MONGOKU_SERVER_ORIGIN: http://localhost:4101
    depends_on:
      mongo:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - found-footy-dev

  # MINIO - S3-compatible object storage
  minio:
    image: minio/minio:latest
    container_name: found-footy-dev-minio
    command: server /data --console-address ":9001"
    ports:
      - "4102:9001"  # MinIO Console
    environment:
      MINIO_ROOT_USER: ffuser
      MINIO_ROOT_PASSWORD: ffpass--
    volumes:
      - found-footy-dev-minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - found-footy-dev
      - luv-dev

  # TEMPORAL SERVER - Workflow orchestration
  temporal:
    image: temporalio/auto-setup:latest
    container_name: found-footy-dev-temporal
    ports:
      - "7233:7233"  # Temporal server
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=ffuser
      - POSTGRES_PWD=ffpass
      - POSTGRES_SEEDS=found-footy-dev-postgres
      - BIND_ON_IP=0.0.0.0  # Bind to all interfaces
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - found-footy-dev
    restart: unless-stopped

  # TEMPORAL UI - Web interface
  temporal-ui:
    image: temporalio/ui:latest
    container_name: found-footy-dev-temporal-ui
    ports:
      - "4100:8080"  # Temporal UI
    environment:
      - TEMPORAL_ADDRESS=found-footy-dev-temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:4100
    depends_on:
      - temporal
    networks:
      - found-footy-dev
    restart: unless-stopped

  # TEMPORAL WORKER - Executes workflows
  worker:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: found-footy-dev-worker
    env_file:
      - .env
    environment:
      PYTHONPATH: /workspace
      TEMPORAL_HOST: found-footy-dev-temporal:7233
      MONGODB_URI: mongodb://ffuser:ffpass@found-footy-dev-mongo:27017/found_footy?authSource=admin
      S3_ENDPOINT_URL: http://found-footy-dev-minio:9000
      S3_ACCESS_KEY: ffuser
      S3_SECRET_KEY: ffpass--
      S3_BUCKET_NAME: footy-videos
      TWITTER_SESSION_URL: http://found-footy-dev-twitter:8888
      FRONTEND_API_URL: http://vedanta-systems-dev-api:3001
    volumes:
      - .:/workspace
      - ~/.config/found-footy:/config  # Cookie backup (shared with twitter service)
    networks:
      - found-footy-dev
      - luv-dev  # Need luv-dev network to reach frontend API
    depends_on:
      - temporal
      - mongo
    restart: unless-stopped
    command: python /workspace/src/worker.py

volumes:
  found-footy-dev-postgres-data:
    name: found-footy-dev-postgres-data
    driver: local
  found-footy-dev-mongo-data:
    name: found-footy-dev-mongo-data
    driver: local
  found-footy-dev-minio-data:
    name: found-footy-dev-minio-data
    driver: local
  found-footy-dev-twitter-cookies:
    name: found-footy-dev-twitter-cookies
    driver: local

networks:
  # Internal network for this project
  found-footy-dev:
    name: found-footy-dev  # Explicit name to avoid Docker Compose prefix
    driver: bridge
  
  # Shared network - frontend and other projects join this to communicate
  luv-dev:
    external: true
