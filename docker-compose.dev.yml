# Development Docker Compose - Multi-project setup
#
# Port allocation: found-footy uses 3100-3109
#   3100: Dagster UI
#   3101: MongoDB Express
#   3102: MinIO Console
#   3103: Twitter API
#   3104: noVNC Browser
#
# Internal communication (standard ports):
#   - found-footy-postgres:5432
#   - found-footy-mongo:27017
#   - found-footy-minio:9000
#   - found-footy-dagster-webserver:3000

services:
  # DEDICATED DEV CONTAINER - VS Code attaches HERE
  # This container ONLY provides Python + tooling for development
  # It does NOT run your application
  dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: found-footy-dev
    volumes:
      - .:/workspace
      - /home/vedanta/.ssh:/root/.ssh:ro
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - found-footy-dev
      - luv-dev
    environment:
      PYTHONPATH: /workspace
      DOCKER_HOST: unix:///var/run/docker.sock
      # Connection strings for services
      DAGSTER_PG_USERNAME: ffuser
      DAGSTER_PG_PASSWORD: ffpass
      DAGSTER_PG_HOST: found-footy-postgres
      DAGSTER_PG_DB: dagster
      MONGODB_URI: mongodb://ffuser:ffpass@found-footy-mongo:27017/found_footy?authSource=admin
      S3_ENDPOINT_URL: http://found-footy-minio:9000
      S3_ACCESS_KEY: ffuser
      S3_SECRET_KEY: ffpass--
    command: sleep infinity
    restart: unless-stopped

  # DAGSTER WEBSERVER - your application UI
  dagster-webserver:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: found-footy-dagster-webserver
    ports:
      - "3100:3000"   # Dagster UI
    env_file:
      - .env
    environment:
      DAGSTER_HOME: /workspace
      DAGSTER_PG_USERNAME: ffuser
      DAGSTER_PG_PASSWORD: ffpass
      DAGSTER_PG_HOST: found-footy-postgres
      DAGSTER_PG_DB: dagster
      DAGSTER_PG_PORT: 5432
      MONGODB_URI: mongodb://ffuser:ffpass@found-footy-mongo:27017/found_footy?authSource=admin
      MONGODB_URL: mongodb://ffuser:ffpass@found-footy-mongo:27017/found_footy?authSource=admin
      S3_ENDPOINT_URL: http://found-footy-minio:9000
      S3_ACCESS_KEY: ffuser
      S3_SECRET_KEY: ffpass--
      S3_BUCKET_NAME: footy-videos
      TWITTER_SESSION_URL: http://found-footy-twitter:8888
      TWITTER_COOKIES_FILE: /data/twitter_cookies.pkl
      PYTHONPATH: /workspace
      PYTHONHTTPSVERIFY: 0
      DISPLAY: ":99"
    volumes:
      - .:/workspace
      - /workspace/dagster_storage
      - /workspace/dagster_logs
      - twitter_cookies_dev:/data
    networks:
      - found-footy-dev
      - luv-dev
    depends_on:
      postgres:
        condition: service_healthy
      mongo:
        condition: service_healthy
    restart: unless-stopped
    command: >
      bash -c "
        mkdir -p /workspace/dagster_storage /workspace/dagster_logs /workspace/downloads /data &&
        dagster-webserver -h 0.0.0.0 -p 3000 -w /workspace/workspace.yaml
      "

  # DAGSTER DAEMON - background job processor
  dagster-daemon:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: found-footy-dagster-daemon
    env_file:
      - .env
    environment:
      DAGSTER_HOME: /workspace
      DAGSTER_PG_USERNAME: ffuser
      DAGSTER_PG_PASSWORD: ffpass
      DAGSTER_PG_HOST: found-footy-postgres
      DAGSTER_PG_DB: dagster
      DAGSTER_PG_PORT: 5432
      MONGODB_URI: mongodb://ffuser:ffpass@found-footy-mongo:27017/found_footy?authSource=admin
      MONGODB_URL: mongodb://ffuser:ffpass@found-footy-mongo:27017/found_footy?authSource=admin
      S3_ENDPOINT_URL: http://found-footy-minio:9000
      S3_ACCESS_KEY: ffuser
      S3_SECRET_KEY: ffpass--
      S3_BUCKET_NAME: footy-videos
      PYTHONPATH: /workspace
      PYTHONHTTPSVERIFY: 0
    volumes:
      - .:/workspace
      - /workspace/dagster_storage
      - /workspace/dagster_logs
      - twitter_cookies_dev:/data
    networks:
      - found-footy-dev
    depends_on:
      - dagster-webserver
    restart: unless-stopped
    command: >
      bash -c "
        mkdir -p /workspace/dagster_storage /workspace/dagster_logs &&
        dagster-daemon run
      "

  # TWITTER SERVICE - handles Twitter scraping with GUI access
  twitter:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: found-footy-twitter
    ports:
      - "3103:8888"  # Twitter API
      - "3104:6080"  # noVNC Browser
    env_file:
      - .env
    environment:
      PYTHONPATH: /workspace
      TWITTER_COOKIES_FILE: /data/twitter_cookies.pkl
      TWITTER_SERVICE_HOST: "0.0.0.0"
      TWITTER_SERVICE_PORT: "8888"
      TWITTER_HEADLESS: "false"  # GUI mode - full browser visible via noVNC!
      DISPLAY: ":99"
      VNC_PORT: "5900"
      NOVNC_PORT: "6080"
    volumes:
      - .:/workspace  # Mount entire project for development
      - twitter_cookies_dev:/data
    networks:
      - found-footy-dev
    restart: unless-stopped
    command: bash /workspace/twitter/start_with_vnc.sh

  # POSTGRESQL - Dagster metadata storage
  postgres:
    image: postgres:15-alpine
    container_name: found-footy-postgres
    # No port mapping - accessed via Dagster UI only
    environment:
      POSTGRES_USER: ffuser
      POSTGRES_PASSWORD: ffpass
      POSTGRES_DB: dagster
    volumes:
      - postgres_data_dev:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ffuser -d dagster"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - found-footy-dev
      - luv-dev

  # MONGODB - application data storage
  mongo:
    image: mongo:7-jammy
    container_name: found-footy-mongo
    # No port mapping - accessed via MongoDB Express dashboard
    environment:
      MONGO_INITDB_ROOT_USERNAME: ffuser
      MONGO_INITDB_ROOT_PASSWORD: ffpass
      MONGO_INITDB_DATABASE: found_footy
    command: >
      mongod
      --setParameter logComponentVerbosity={network:{verbosity:0},storage:{verbosity:0}}
    volumes:
      - mongo_data_dev:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - found-footy-dev
      - luv-dev

  # MONGODB EXPRESS - MongoDB web UI
  mongo-express:
    image: mongo-express:1.0.2-20-alpine3.19
    container_name: found-footy-mongo-express
    ports:
      - "3101:8081"  # MongoDB Express
    environment:
      ME_CONFIG_MONGODB_SERVER: found-footy-mongo
      ME_CONFIG_MONGODB_PORT: 27017
      ME_CONFIG_MONGODB_ADMINUSERNAME: ffuser
      ME_CONFIG_MONGODB_ADMINPASSWORD: ffpass
      ME_CONFIG_MONGODB_AUTH_DATABASE: admin
      ME_CONFIG_BASICAUTH_USERNAME: ffuser
      ME_CONFIG_BASICAUTH_PASSWORD: ffpass
    depends_on:
      mongo:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://ffuser:ffpass@127.0.0.1:8081"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - found-footy-dev

  # MINIO - S3-compatible object storage
  minio:
    image: minio/minio:latest
    container_name: found-footy-minio
    command: server /data --console-address ":9001"
    ports:
      - "3102:9001"  # MinIO Console
    environment:
      MINIO_ROOT_USER: ffuser
      MINIO_ROOT_PASSWORD: ffpass--
    volumes:
      - minio_data_dev:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - found-footy-dev
      - luv-dev

volumes:
  postgres_data_dev:
    driver: local
  mongo_data_dev:
    driver: local
  minio_data_dev:
    driver: local
  twitter_cookies_dev:
    driver: local

networks:
  # Internal network for this project
  found-footy-dev:
    name: found-footy-dev  # Explicit name to avoid Docker Compose prefix
    driver: bridge
  
  # Shared network - frontend and other projects join this to communicate
  luv-dev:
    external: true
